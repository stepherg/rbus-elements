name: Build Debian Packages

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created, published]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  actions: read
  id-token: write

jobs:
  build:
    name: Build ${{ matrix.platform }} deb
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: amd64
            docker_platform: linux/amd64
          - platform: arm64
            docker_platform: linux/arm64
    env:
      BUILD_TYPE: Release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build rbus-elements package
        run: |
          mkdir -p build
          docker run --rm --platform=${{ matrix.docker_platform }} \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            ubuntu:20.04 \
            bash -c '
              set -e
              export DEBIAN_FRONTEND=noninteractive
              apt-get update -qq
              apt-get install -y -qq build-essential cmake pkg-config file wget \
                libmsgpackc2 libmsgpack-dev libcjson-dev libjansson-dev
              
              # Install rbus package dependencies
              RBUS_VERSION="2.7.0"
              wget -q https://github.com/stepherg/rbus/releases/download/v${RBUS_VERSION}/liblinenoise_1.0_${{ matrix.platform }}.deb
              wget -q https://github.com/stepherg/rbus/releases/download/v${RBUS_VERSION}/rbus_${RBUS_VERSION}_${{ matrix.platform }}.deb
              dpkg -i liblinenoise_1.0_${{ matrix.platform }}.deb || true
              dpkg -i rbus_${RBUS_VERSION}_${{ matrix.platform }}.deb || true
              apt-get install -f -y
              
              rm -rf build
              mkdir -p build
              cd build
              cmake -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} ..
              cmake --build . --config ${{ env.BUILD_TYPE }} -- -j$(nproc)
              cpack -G DEB
              
              chown -R $(stat -c "%u:%g" /workspace) /workspace/build || true
            '
          ls -lh build/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rbus-elements-${{ matrix.platform }}-deb
          path: build/*.deb
          if-no-files-found: error

  upload-to-release:
    name: Upload to Release
    needs: build
    runs-on: ubuntu-22.04
    if: github.event_name == 'release'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
